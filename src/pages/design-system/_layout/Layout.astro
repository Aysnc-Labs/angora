---
import '../../../styles/global.css';
import '../../../styles/reset.css';
import '../../../styles/design-system.css';

interface Props {
  title: string;
  description?: string;
  fullscreenHref?: string;
}

const { title, description, fullscreenHref } = Astro.props;

const layouts = [
  { href: '/design-system/layouts/home', label: 'Home' },
];
const components = [
  { href: '/design-system', label: 'Style Guide' },
  { href: '/design-system/buttons', label: 'Buttons' },
  { href: '/design-system/icons', label: 'Icons' },
  { href: '/design-system/grid', label: 'Grid' },
  { href: '/design-system/cards', label: 'Cards' },
  { href: '/design-system/forms', label: 'Forms' },
];
const wireframes = [
  { href: '/design-system/wireframes/home', label: 'Home' },
];

const currentPath = Astro.url.pathname.replace(/\/$/, '') || '/';
const isInGroup = (items: { href: string }[]) =>
  items.some(({ href }) => currentPath === href.replace(/\/$/, ''));
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <title>{title} — Design System</title>
  </head>
  <body>
    <div class="ds-shell">
      <aside class="ds-sidebar">
        <div class="ds-sidebar-top">
          <a href="/design-system" class="ds-sidebar-brand">Angora</a>
          <a href="/" class="ds-sidebar-site-link">← Back to site</a>
        </div>

        <input type="search" class="ds-nav-search" placeholder="Search…" aria-label="Search design system" />

        <nav class="ds-nav">
          <details open={isInGroup(layouts)}>
            <summary class="ds-nav-summary">Layouts</summary>
            <div class="ds-nav-group">
              {layouts.map(({ href, label }) => (
                <a href={href} target="_blank">
                  {label}
                  <svg class="ds-nav-external-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </a>
              ))}
            </div>
          </details>

          <details open={isInGroup(components)}>
            <summary class="ds-nav-summary">Components</summary>
            <div class="ds-nav-group">
              {components.map(({ href, label }) => (
                <a
                  href={href}
                  aria-current={currentPath === href.replace(/\/$/, '') ? 'page' : undefined}
                >
                  {label}
                </a>
              ))}
            </div>
          </details>

          <details open={isInGroup(wireframes)}>
            <summary class="ds-nav-summary">Wireframes</summary>
            <div class="ds-nav-group">
              {wireframes.map(({ href, label }) => (
                <a
                  href={href}
                  aria-current={currentPath === href.replace(/\/$/, '') ? 'page' : undefined}
                >
                  {label}
                </a>
              ))}
            </div>
          </details>
        </nav>
      </aside>

      <script>
        const search = document.querySelector<HTMLInputElement>('.ds-nav-search');
        const nav = document.querySelector('.ds-nav');
        if (search && nav) {
          const groups = nav.querySelectorAll('details');
          // Remember which groups were open before searching
          const defaultOpen = new Set<Element>();
          groups.forEach(d => { if (d.open) defaultOpen.add(d); });

          search.addEventListener('input', () => {
            const q = search.value.trim().toLowerCase();

            if (!q) {
              // Restore default state
              groups.forEach(d => {
                d.style.display = '';
                d.open = defaultOpen.has(d);
                d.querySelectorAll('.ds-nav-group a').forEach(a =>
                  (a as HTMLElement).style.display = ''
                );
              });
              return;
            }

            // Filter groups
            groups.forEach(d => {
              const links = d.querySelectorAll('.ds-nav-group a');
              let hasMatch = false;
              links.forEach(a => {
                const match = a.textContent?.toLowerCase().includes(q);
                (a as HTMLElement).style.display = match ? '' : 'none';
                if (match) hasMatch = true;
              });
              d.style.display = hasMatch ? '' : 'none';
              if (hasMatch) d.open = true;
            });
          });
        }
      </script>
      <main class="ds-page">
        <div class="ds-page-header">
          <h1>{title}</h1>
          {fullscreenHref && <a href={fullscreenHref} class="ds-fullscreen-link" target="_blank">View full screen</a>}
        </div>
        {description && <p class="ds-desc">{description}</p>}
        <slot />
      </main>
    </div>
  </body>
</html>
